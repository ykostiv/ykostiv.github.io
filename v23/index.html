  <!doctype html>

  <title>DevHub CI/CD YAML Converter</title>
  <meta charset="utf-8"/>

  <link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata|Roboto|Source+Code+Pro&display=swap">
  <link rel=stylesheet href="lib/codemirror.css"></link>
  <link rel=stylesheet href="v23web.css"></link>
  <link rel=stylesheet href="theme/nord.css"></link>
  <link rel="shortcut icon" type="image/png" href="favicon.ico" />
  <script src="lib/codemirror.js"></script>
  <script src="mode/yaml/yaml.js"></script>
  <script src="addon/selection/active-line.js"></script>
  <script src="https://cdn.jsdelivr.net/es5.shim/4.4.1/es5-shim.min.js"></script>
  <script src="lib/suncalc.js"></script>
  <script src="lib/js-yaml.min.js"></script>
  <script src="v23web.js"></script>

  <article>

  <section id=content>
    <div class="header">
      <img src="Logo.png" alt="logo" />
      <h1>  YAML v2 to v3 converter</h1>
    </div>
    <div class="content">
      <div class="src">
        <h4 class="subheader">Edit source v2 YAML here:</h4>
        <textarea id="source">
version: v2
navigator:
  name: Service DevHub
  email: dhService@trilogy.com
tickets:
  engImportTicket: https://jira.devfactory.com/browse/Y3K-1
  devHubTicket:    https://jira.devfactory.com/browse/Y3K-2
  dockerTicket:    null
  devSpacesTicket: null
  vmTicket:        null
repo:
  companyName: DevFactory
  productName: IMPDH
  repoUrl: https://github.com/trilogy-group/v23yaml
  repoBranch: master
  repoType: Final deployable
  githubTokenSecretId: github-access
buildDeps:
build:
  techStack: Node.js
  buildOs: Ubuntu 18.04
  runtimeVersion: Node.js 10
  buildTool: npm
  preBuild: echo skip
  buildCommand: npm install
buildenvVars:
test:
  utFramework: Karma
  preTest:
  testCommand: echo Skip
package:
  packageTool:
  packageCommand: echo skip
  artifactDir: ./target
deploy:
  serviceName: y23-converter
  deploymentCheck: echo skip
  stickySessions: False
  canUseLb: False
  stablePersistence: False
  fixedNetworkIdentifier: False
  envVars: null
  run: echo "unimportant string"
run:
  dockerized: False
  runtimeOs: Ubuntu 18.04
  runtimeEnv: None
  installScript: echo Skip
  runCommand: echo Skip
  userName: root
        </textarea>
      </div>
      <div class="dst">
        <h4 class="subheader">Converted YAML v3 is here:</h4>
        <textarea id="result">
        </textarea>
      </div>
      <div class="gh-ribbon">
        <a href="https://sites.google.com/devfactory.com/devhub" target="_blank" title="DevHub Portal">DevHub</a>
      </div>
    </div>
    <div class="footer">Copyright (c) 2020 ESW Capital, DevFactory</div>

    <script>

    // Theme switch depending on sunrise/sunset times (WIP)

      var today = new Date();
      var currentTime = today.getHours() + today.getMinutes()/60;
      var timeZone = today.getTimezoneOffset()/60;
      var position = {lat: 51.5, long: -0.1}; // default London latitude and longitude

    	function callback(data)
    	{
    		position.lat = data.latitude;
    		position.long = data.longitude;
    	}

    	var script = document.createElement('script');
    	script.type = 'text/javascript';
    	script.src = 'https://geolocation-db.com/jsonp';
    	var h = document.getElementsByTagName('script')[0];
    	h.parentNode.insertBefore(script, h);

      window.onload = function () {

        var times = SunCalc.getTimes(new Date(), position.lat, position.long);
        var sunRise = times.sunriseEnd.getHours() + times.sunriseEnd.getMinutes()/60;
        var sunSet = times.sunsetStart.getHours() + times.sunsetStart.getMinutes()/60;

        console.log("Curr: %s, SunRise: %s, SunSet: %s", currentTime, sunRise, sunSet);

        if (sunRise <= currentTime&&currentTime < sunSet) {
          document.body.className = "day";
          var cmTheme = "default";
        } else {
            document.body.className = "night";
            var cmTheme = "nord";
          }

        // Creating source editor window
        source = CodeMirror.fromTextArea(document.getElementById('source'), {
          mode: 'text/yaml',
          lineNumbers: true,
          styleActiveLine: true,
          theme: cmTheme
        });

        // Conversion
        var v2 = jsyaml.safeLoad(source.options.value);
        if (v2.version != "v2" & v2.version != "2.0" & v2.version != "2") {
          result = "\nSource is not a V2 YAML\n";
        } else {
          var v3 = convert(v2);
          var result = jsyaml.safeDump(v3);
        }

        // Actual result update
        document.getElementById('result').innerHTML = result;

        // Creating result viewer window
        var target = CodeMirror.fromTextArea(document.getElementById('result'), {
          lineNumbers: false,
          mode: "text/yaml",
          styleActiveLine: false,
          readOnly: true,
          theme: cmTheme
        });

        // Handling editor changes
        source.on('change', function () {
          var ddoc = source.doc.getValue();
          var timer;
          clearTimeout(timer);
          timer = setTimeout( function () {
            try {
              v2 = jsyaml.safeLoad(ddoc);
              if (v2.version != "v2" & v2.version != "2.0" & v2.version != "2") {
                result = "\nSource is not a V2 YAML\n";
              } else {
                v3 = convert(v2);
                result = jsyaml.safeDump(v3);
              }
            } catch (e) {
              result = "\nERROR: Source YAML fails validation\n";
            }
            target.doc.setValue(result);
          }, 500);

        });
      };

    </script>
  </section>
  </article>
